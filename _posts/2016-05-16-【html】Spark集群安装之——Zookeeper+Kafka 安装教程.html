<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spark集群安装之——Zookeeper+Kafka 安装教程</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h1 id="1安装和配置zookeeper">1、安装和配置Zookeeper</h1>



<h2 id="1-下载zookeeper">1)   下载Zookeeper</h2>

<p>进入<a href="http://www.apache.org/dyn/closer.cgi/zookeeper/">http://www.apache.org/dyn/closer.cgi/zookeeper/</a>，你可以选择其他镜像网址去下载，用官网推荐的镜像：<a href="http://mirror.bit.edu.cn/apache/zookeeper/">http://mirror.bit.edu.cn/apache/zookeeper/</a></p>

<p>下载zookeeper-3.4.6.tar.gz</p>



<h2 id="2-安装zookeeper">2)   安装Zookeeper</h2>

<p>提示：下面的步骤发生在Master服务器。</p>

<p>以ubuntu14.04举例，把下载好的文件放到/root目录，用下面的命令解压：</p>



<pre class="prettyprint"><code class=" hljs avrasm">cd /root
tar -zxvf zookeeper-<span class="hljs-number">3.4</span><span class="hljs-number">.6</span><span class="hljs-preprocessor">.tar</span><span class="hljs-preprocessor">.gz</span></code></pre>

<p>解压后在/root目录会多出一个zookeeper-3.4.6的新目录，用下面的命令把它剪切到指定目录即安装好Zookeeper了：</p>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">cd</span> /root
mv zookeeper-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span> /usr/local/spark</code></pre>

<p>之后在/usr/local/spark目录会多出一个zookeeper-3.4.6的新目录。下面我们讲如何配置安装好的Zookeeper。</p>



<h2 id="3-配置zookeeper">3)   配置Zookeeper</h2>

<p>提示：下面的步骤发生在master服务器。</p>



<h3 id="a-配置bashrc">a.   配置.bashrc</h3>

<ul>
<li>打开文件：<code>vi /root/.bashrc</code></li>
<li>在PATH配置行前添加：</li>
</ul>



<pre class="prettyprint"><code class=" hljs ruby">export <span class="hljs-constant">ZOOKEEPER_HOME</span>=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/spark/zookeeper</span>-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span></code></pre>

<ul>
<li>最后修改PATH：</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-keyword">export</span> PATH=<span class="hljs-variable">${JAVA_HOME}</span>/bin:<span class="hljs-variable">${ZOOKEEPER_HOME}</span>/bin:<span class="hljs-variable">${HADOOP_HOME}</span>/bin:<span class="hljs-variable">${HADOOP_HOME}</span>/sbin:<span class="hljs-variable">${SCALA_HOME}</span>/bin:<span class="hljs-variable">${SPARK_HOME}</span>/bin:<span class="hljs-variable">${SPARK_HOME}</span>/sbin:<span class="hljs-variable">${HIVE_HOME}</span>/bin:<span class="hljs-variable">${KAFKA_HOME}</span>/bin:<span class="hljs-variable">$PATH</span></code></pre>

<ul>
<li>使配置的环境变量立即生效：source /root/.bashrc</li>
</ul>



<h3 id="b-创建data目录">b.  创建data目录</h3>



<pre class="prettyprint"><code class=" hljs bash">    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$ZOOKEEPER_HOME</span></code></pre>



<pre class="prettyprint"><code class=" hljs haskell">    mkdir <span class="hljs-typedef"><span class="hljs-keyword">data</span></span></code></pre>



<h3 id="c-创建并打开zoocfg文件">c.  创建并打开zoo.cfg文件</h3>



<pre class="prettyprint"><code class=" hljs avrasm">    cd $ZOOKEEPER_HOME/conf
    <span class="hljs-keyword">cp</span> zoo_sample<span class="hljs-preprocessor">.cfg</span> zoo<span class="hljs-preprocessor">.cfg</span>
    vi zoo<span class="hljs-preprocessor">.cfg</span></code></pre>



<h3 id="d-配置zoocfg">d.  配置zoo.cfg</h3>



<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor"># 配置Zookeeper的日志和服务器身份证号等数据存放的目录。</span>
<span class="hljs-preprocessor"># 千万不要用默认的/tmp/zookeeper目录，因为/tmp目录的数据容易被意外删除。</span>
dataDir=../data
<span class="hljs-preprocessor"># Zookeeper与客户端连接的端口</span>
clientPort=<span class="hljs-number">2181</span>
<span class="hljs-preprocessor"># 在文件最后新增3行配置每个服务器的2个重要端口：Leader端口和选举端口</span>
<span class="hljs-preprocessor"># server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；</span>
<span class="hljs-preprocessor"># B 是这个服务器的hostname或ip地址；</span>
<span class="hljs-preprocessor"># C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；</span>
<span class="hljs-preprocessor"># D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，</span>
<span class="hljs-preprocessor"># 选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。</span>
<span class="hljs-preprocessor"># 如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信</span>
<span class="hljs-preprocessor"># 端口号不能一样，所以要给它们分配不同的端口号。</span>
server<span class="hljs-number">.1</span>=Master:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.2</span>=Worker1:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
<span class="hljs-preprocessor">#server.3=Worker2:2888:3888</span></code></pre>



<h3 id="e-创建并打开myid文件">e.  创建并打开myid文件</h3>



<pre class="prettyprint"><code class=" hljs haml">-<span class="ruby">   cd <span class="hljs-variable">$ZOOKEEPER_HOME</span>/data
</span>-<span class="ruby">   touch myid
</span>-<span class="ruby">   vi myid</span></code></pre>



<h3 id="f-配置myid">f.  配置myid</h3>

<p>按照zoo.cfg的配置，myid的内容就是1。</p>



<h2 id="4-同步master的安装和配置到slave1和slave2">4)    同步master的安装和配置到slave1和slave2</h2>

<ul>
<li>在master服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs ruby">cd /root
scp ./.bashrc root<span class="hljs-variable">@slave1</span><span class="hljs-symbol">:/root</span>
scp ./.bashrc root<span class="hljs-variable">@slave2</span><span class="hljs-symbol">:/root</span>
cd /usr/local/spark
scp -r ./zookeeper-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span> root<span class="hljs-variable">@slave1</span><span class="hljs-symbol">:/usr/local/spark</span>
scp -r ./zookeeper-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span> root<span class="hljs-variable">@slave2</span><span class="hljs-symbol">:/usr/local/spark</span></code></pre>

<ul>
<li>在slave1服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">vim</span> $<span class="hljs-type">ZOOKEEPER_HOME</span>/<span class="hljs-typedef"><span class="hljs-keyword">data</span>/myid</span></code></pre>

<p>按照zoo.cfg的配置，myid的内容就是2。 <br>
-   在slave2服务器上运行下面的命令</p>



<pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">vim</span> $<span class="hljs-type">ZOOKEEPER_HOME</span>/<span class="hljs-typedef"><span class="hljs-keyword">data</span>/myid</span></code></pre>

<p>按照zoo.cfg的配置，myid的内容就是3。 <br>
5)  启动Zookeeper服务 <br>
-   在Master服务器上运行下面的命令</p>



<pre class="prettyprint"><code class=" hljs sql">zkServer.sh <span class="hljs-operator"><span class="hljs-keyword">start</span></span></code></pre>

<ul>
<li>在slave1服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">source</span> /root/.bashrc</code></pre>

<p>zkServer.sh start <br>
-   在slave1服务器上运行下面的命令</p>



<pre class="prettyprint"><code class=" hljs avrasm">source /root/<span class="hljs-preprocessor">.bashrc</span>
zkServer<span class="hljs-preprocessor">.sh</span> start</code></pre>

<p>6)  验证Zookeeper是否安装和启动成功</p>

<ul>
<li>在master服务器上运行命令：jps和zkServer.sh status</li>
</ul>



<pre class="prettyprint"><code class=" hljs ruby">root<span class="hljs-variable">@Master</span><span class="hljs-symbol">:/usr/local/spark/zookeeper-</span><span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin<span class="hljs-comment"># jps</span>
<span class="hljs-number">3844</span> <span class="hljs-constant">QuorumPeerMain</span>
<span class="hljs-number">4790</span> <span class="hljs-constant">Jps</span>
zkServer.sh status
root<span class="hljs-variable">@Master</span><span class="hljs-symbol">:/usr/local/spark/zookeeper-</span><span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin<span class="hljs-comment"># zkServer.sh status</span>
<span class="hljs-constant">JMX</span> enabled by default
<span class="hljs-constant">Using</span> <span class="hljs-symbol">config:</span> /usr/local/spark/zookeeper-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin/../conf/zoo.cfg
<span class="hljs-constant">Mode</span><span class="hljs-symbol">:</span> follower</code></pre>

<ul>
<li>在Worker1服务器上运行命令：jps和zkServer.sh status</li>
</ul>



<pre class="prettyprint"><code class=" hljs ruby">root<span class="hljs-variable">@Worker1</span><span class="hljs-symbol">:/usr/local/spark/zookeeper-</span><span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin<span class="hljs-comment"># jps</span>
<span class="hljs-number">4073</span> <span class="hljs-constant">Jps</span>
<span class="hljs-number">3277</span> <span class="hljs-constant">QuorumPeerMain</span>
root<span class="hljs-variable">@Worker1</span><span class="hljs-symbol">:/usr/local/spark/zookeeper-</span><span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin<span class="hljs-comment"># zkServer.sh status</span>
<span class="hljs-constant">JMX</span> enabled by default
<span class="hljs-constant">Using</span> <span class="hljs-symbol">config:</span> /usr/local/spark/zookeeper-<span class="hljs-number">3.4</span>.<span class="hljs-number">6</span>/bin/../conf/zoo.cfg
<span class="hljs-constant">Mode</span><span class="hljs-symbol">:</span> leader /<span class="hljs-regexp">/可以看到这个服务器被选举为leader</span></code></pre>

<pre><code>至此，代表Zookeeper已经安装和配置成功。
</code></pre>



<h1 id="2安装和配置kafka">2、安装和配置Kafka</h1>



<h2 id="1-下载kafka">1)   下载Kafka</h2>

<p>进入<a href="http://kafka.apache.org/downloads.html">http://kafka.apache.org/downloads.html</a>，左键单击kafka_2.10-0.9.0.1.tgz。</p>



<h2 id="2-安装kafka">2)   安装Kafka</h2>

<p>提示：下面的步骤发生在master服务器。 <br>
以ubuntu14.04举例，把下载好的文件放到/root目录，用下面的命令解压：</p>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">cd</span> /root
tar -zxvf kafka_2.<span class="hljs-number">10</span>-<span class="hljs-number">0.9</span>.<span class="hljs-number">0.1</span>.tgz</code></pre>

<p>解压后在/root目录会多出一个kafka_2.10-0.9.0.1的新目录，用下面的命令把它剪切到指定目录即安装好Kafka了：</p>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">cd</span> /root
mv kafka_2.<span class="hljs-number">10</span>-<span class="hljs-number">0.9</span>.<span class="hljs-number">0.1</span> /usr/local</code></pre>

<p>之后在/usr/local目录会多出一个kafka_2.10-0.9.0.1的新目录。下面我们讲如何配置安装好的Kafka。</p>

<p>把jar包slf4j-nop-1.7.6.jar拷入到Kafka的libs里面，可以让Kafka后台运行！命令后面的&amp;生效 。否则不生效。</p>



<h2 id="3-配置kafka">3)   配置Kafka</h2>

<p>提示：下面的步骤发生在master服务器。</p>



<h3 id="a-配置bashrc-1">a.  配置.bashrc</h3>

<ul>
<li>打开文件：vi /root/.bashrc</li>
<li>在PATH配置行前添加：</li>
</ul>



<pre class="prettyprint"><code class=" hljs autohotkey">export KAFK<span class="hljs-built_in">A_HOME</span>=/usr/local/kafk<span class="hljs-built_in">a_2</span>.<span class="hljs-number">10</span>-<span class="hljs-number">0.9</span>.<span class="hljs-number">0.1</span></code></pre>

<ul>
<li>最后修改PATH：</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-keyword">export</span> PATH=<span class="hljs-variable">${JAVA_HOME}</span>/bin:<span class="hljs-variable">${ZOOKEEPER_HOME}</span>/bin:<span class="hljs-variable">${HADOOP_HOME}</span>/bin:<span class="hljs-variable">${HADOOP_HOME}</span>/sbin:<span class="hljs-variable">${SCALA_HOME}</span>/bin:<span class="hljs-variable">${SPARK_HOME}</span>/bin:<span class="hljs-variable">${SPARK_HOME}</span>/sbin:<span class="hljs-variable">${HIVE_HOME}</span>/bin:<span class="hljs-variable">${KAFKA_HOME}</span>/bin:<span class="hljs-variable">$PATH</span></code></pre>

<ul>
<li>使配置的环境变量立即生效：</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">source</span> /root/.bashrc</code></pre>



<h3 id="b-打开serverproperties">b.   打开server.properties</h3>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$ZOOKEEPER_HOME</span>/config
vi server.properties</code></pre>



<h3 id="c-配置serverproperties">c.   配置server.properties</h3>



<pre class="prettyprint"><code class=" hljs avrasm">broker<span class="hljs-preprocessor">.id</span>=<span class="hljs-number">0</span>
port=<span class="hljs-number">9092</span>
zookeeper<span class="hljs-preprocessor">.connect</span>=master:<span class="hljs-number">2181</span>,slave1:<span class="hljs-number">2181</span>,slave2:<span class="hljs-number">2181</span></code></pre>

<blockquote>
  <p>注意：2181就是和Zookeeper通信的端口。 因为在Zookeeper里面 有个配置为：clientPort = 2181 <br>
  再备注： Zookeeper中的配置 server.0 = Master:2888:3888 其中一个端口用于通信，另一个端口用于选举！</p>
</blockquote>



<h2 id="4-同步master的安装和配置到slave1和slave2-1">4)   同步master的安装和配置到slave1和slave2</h2>

<ul>
<li>在master服务器上运行下面的命令 <br>
cd /root <br>
scp ./.bashrc root@slave1:/root <br>
scp ./.bashrc root@slave2:/root <br>
cd /usr/local <br>
scp -r ./kafka_2.10-0.9.0.1 root@slave1:/usr/local <br>
scp -r ./kafka_2.10-0.9.0.1 root@slave2:/usr/local</li>
<li>在slave1服务器上运行下面的命令 <br>
vi $KAFKA_HOME/config/server.properties <br>
修改broker.id=1。</li>
<li>在slave2服务器上运行下面的命令 <br>
vi $KAFKA_HOME/config/server.properties <br>
修改broker.id=2。</li>
</ul>



<h2 id="5-启动kafka服务">5)   启动Kafka服务</h2>

<ul>
<li>在master服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs lasso">cd <span class="hljs-variable">$KAFKA_HOME</span>/bin
kafka<span class="hljs-attribute">-server</span><span class="hljs-attribute">-start</span><span class="hljs-built_in">.</span>sh <span class="hljs-built_in">..</span>/config/server<span class="hljs-built_in">.</span>properties <span class="hljs-subst">&amp;</span></code></pre>

<ul>
<li>在slave1服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">source</span> /root/.bashrc
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$KAFKA_HOME</span>/bin
kafka-server-start.sh ../config/server.properties &amp;</code></pre>

<ul>
<li>在slave2服务器上运行下面的命令</li>
</ul>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">source</span> /root/.bashrc
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$KAFKA_HOME</span>/bin
kafka-server-start.sh ../config/server.properties &amp;</code></pre>

<p>6)  验证Kafka是否安装和启动成功（话题、生产者、消费者） <br>
-   在任意服务器上运行命令创建Topic“HelloKafka”： <br>
kafka-topics.sh –create –zookeeper master:2181,slave1:2181,slave2:2181 –replication-factor 3 –partitions 1 –topic HelloKafka</p>



<pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">kafka</span><span class="hljs-literal">-</span><span class="hljs-comment">topics</span><span class="hljs-string">.</span><span class="hljs-comment">sh</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">create</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">zookeeper</span> <span class="hljs-comment">Master:2181</span><span class="hljs-string">,</span><span class="hljs-comment">Worker1:2181</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">replication</span><span class="hljs-literal">-</span><span class="hljs-comment">factor</span> <span class="hljs-comment">2</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">partitions</span> <span class="hljs-comment">1</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">topic</span> <span class="hljs-comment">HelloKafka</span></code></pre>

<p>注意：create 用的2181端口；</p>

<ul>
<li>在任意服务器上运行命令为创建的Topic“HelloKafka”生产一些消息： <br>
kafka-console-producer.sh –broker-list master:9092,slave1:9092,slave2:9092 –topic HelloKafka</li>
</ul>



<pre class="prettyprint"><code class=" hljs lasso">kafka<span class="hljs-attribute">-console</span><span class="hljs-attribute">-producer</span><span class="hljs-built_in">.</span>sh <span class="hljs-subst">--</span>broker<span class="hljs-attribute">-list</span> Master:<span class="hljs-number">9092</span>, Worker1:<span class="hljs-number">9092</span> <span class="hljs-subst">--</span>topic HelloKafka</code></pre>

<p>注意：producer 用的9092端口；发给Kafka，Kafka用的端口号是9092。</p>

<p>输入下面的消息内容： <br>
This is DT_Spark! <br>
I’m Rocky! <br>
Life is short, you need Spark! <br>
-   在任意服务器上运行命令从指定的Topic“HelloKafka”上消费（拉取）消息： <br>
kafka-console-consumer.sh –zookeeper master:2181,slave1:2181,slave2:2181 –from-beginning –topic HelloKafka</p>

<blockquote>
  <p>2181就是和Zookeeper通信的端口</p>
</blockquote>



<pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">kafka</span><span class="hljs-literal">-</span><span class="hljs-comment">console</span><span class="hljs-literal">-</span><span class="hljs-comment">consumer</span><span class="hljs-string">.</span><span class="hljs-comment">sh</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">zookeeper</span> <span class="hljs-comment">Master:2181</span><span class="hljs-string">,</span> <span class="hljs-comment">Worker1:2181</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">from</span><span class="hljs-literal">-</span><span class="hljs-comment">beginning</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">topic</span> <span class="hljs-comment">HelloKafka</span></code></pre>

<p>注释：from-beginning  <br>
过一会儿，你会看到打印的消息内容： <br>
    This is DT_Spark! <br>
    I’m Rocky! <br>
    Life is short, you need Spark! <br>
-   在任意服务器上运行命令查看所有的Topic名字： <br>
kafka-topics.sh –list –zookeeper master:2181,slave1:2181,slave2:2181 <br>
-   在任意服务器上运行命令查看指定Topic的概况： <br>
kafka-topics.sh –describe –zookeepermaster:2181,slave1:2181,slave2:2181 –topic HelloKafka <br>
至此，代表Kafka已经安装和配置成功。</p>



<h3 id="升级测试">升级测试：</h3>

<p>测试Kafka 的大吞吐量。可以用更大的数据！！ <br>
在某个目录用hadoop dfs –get /library/…./read.me 可以把hdfs上的文件下载到这个目录。 <br>
拷贝6万行数据进入，那样 zerocopy 基本没延迟！！！ <br>
flume接上Kafka ，直接把文件扔给flume，flume接上Kafka，消费者就能直接拿到数据。</p>

<p>备注: <br>
 Zookeeper和大数据没关系，也可以用于JavaEE</p>

<p>传输数据以broker为单位。指定了Master:9092, Worker1:9092。</p></div></body>
</html>